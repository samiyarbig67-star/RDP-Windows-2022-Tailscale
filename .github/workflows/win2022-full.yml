name: HenWindows 2022 NoMachine (NX)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 9999

    steps:
    - name: 1. Install Tailscale
      # نصب دستی Tailscale طبق کد قبلی شما
      run: |
        Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
        Start-Process tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait

    - name: 2. Add Tailscale to PATH
      run: |
        [System.Environment]::SetEnvironmentVariable('PATH', $env:PATH + ";C:\Program Files\Tailscale", [System.EnvironmentVariableTarget]::Machine)

    - name: 3. Authenticate Tailscale
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $Env:TAILSCALE_AUTHKEY --hostname "Github-NoMachine"

    - name: 4. Install NoMachine (NX Protocol)
      # نصب NoMachine با استفاده از Chocolatey (روش استاندارد ویندوز)
      run: |
        Write-Host "Installing NoMachine..."
        choco install nomachine -y --ignore-checksums
        
        # اطمینان از اجرای سرویس
        Start-Sleep -Seconds 10
        Get-Service -Name "nxserver" | Start-Service -PassThru

    - name: 5. Configure System & Firewall
      run: |
        # باز کردن پورت 4000 برای NoMachine
        New-NetFirewallRule -DisplayName "NoMachine-NX" -Direction Inbound -LocalPort 4000 -Protocol TCP -Action Allow
        
        # تنظیم رمز عبور برای یوزر اصلی (runneradmin)
        # این رمز را باید در برنامه NoMachine وارد کنید
        $pass = ConvertTo-SecureString "HenWindows2024!" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $pass
        
        # جلوگیری از به خواب رفتن سیستم
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0

    - name: 6. Get Connection Info
      run: |
        $tailscale_ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        Write-Host "==================================================="
        Write-Host "CONNECTION DETAILS for NoMachine:"
        Write-Host "Protocol: NX"
        Write-Host "Host: $tailscale_ip"
        Write-Host "Port: 4000"
        Write-Host "Username: runneradmin"
        Write-Host "Password: HenWindows2024!"
        Write-Host "==================================================="

    - name: 7. Keep Alive (Loop)
      # حلقه برای روشن نگه داشتن سرور
      run: |
        Write-Host "Server is running. Connect via NoMachine now."
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host "Still running..."
        }
