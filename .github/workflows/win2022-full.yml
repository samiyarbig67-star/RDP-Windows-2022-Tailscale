name: HenWindows 2022 NoMachine (Fixed)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 9999

    steps:
    - name: 1. Install Tailscale
      run: |
        Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
        Start-Process tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait

    - name: 2. Add Tailscale to PATH
      run: |
        [System.Environment]::SetEnvironmentVariable('PATH', $env:PATH + ";C:\Program Files\Tailscale", [System.EnvironmentVariableTarget]::Machine)

    - name: 3. Authenticate Tailscale
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $Env:TAILSCALE_AUTHKEY --hostname "Github-NoMachine"

    - name: 4. Install NoMachine (Safe Mode)
      run: |
        Write-Host "Installing NoMachine..."
        # نصب بدون چک کردن checksum برای جلوگیری از ارور
        choco install nomachine -y --ignore-checksums --force
        
        Write-Host "Installation done. Waiting for files..."
        Start-Sleep -Seconds 20

    - name: 5. Start NoMachine Manually
      # این بخش جایگزین کدی شده که ارور میداد
      run: |
        $nxPath = "C:\Program Files (x86)\NoMachine\bin\nxserver.exe"
        
        if (Test-Path $nxPath) {
            Write-Host "Found NoMachine executable. Attempting to start..."
            # تلاش برای استارت دستی به جای سرویس
            try {
                & $nxPath --startup
                Write-Host "NoMachine startup command executed."
            } catch {
                Write-Host "Could not start nxserver via command line. Ignoring..."
            }
        } else {
            Write-Host "WARNING: NoMachine path not found. You might need to use RDP."
        }

    - name: 6. Configure System & Firewall
      run: |
        # باز کردن پورت 4000
        New-NetFirewallRule -DisplayName "NoMachine-NX" -Direction Inbound -LocalPort 4000 -Protocol TCP -Action Allow
        
        # تنظیم رمز عبور
        $pass = ConvertTo-SecureString "HenWindows2024!" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $pass
        
        # فعال کردن RDP به عنوان بکاپ (چون NoMachine بدون ریستارت ممکن است تصویر ندهد)
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: 7. Get Connection Info
      run: |
        $tailscale_ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        Write-Host "==================================================="
        Write-Host "CONNECTION DETAILS"
        Write-Host "IP: $tailscale_ip"
        Write-Host "Username: runneradmin"
        Write-Host "Password: HenWindows2024!"
        Write-Host "---------------------------------------------------"
        Write-Host "Try NoMachine (Port 4000)"
        Write-Host "If NoMachine fails (Black Screen), use RDP (Port 3389)"
        Write-Host "==================================================="

    - name: 8. Keep Alive
      run: |
        Write-Host "Server is running..."
        while ($true) {
          Start-Sleep -Seconds 60
        }
          Start-Sleep -Seconds 60
          Write-Host "Still running..."
        }
